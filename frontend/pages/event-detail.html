<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–î–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è - PepeShnele</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <nav class="navbar">
    <div class="navbar-container">
      <a href="/frontend/index.html" class="navbar-brand">üé≠ PepeShnele</a>
      <button class="navbar-toggle">‚ò∞</button>
      <ul class="navbar-menu">
        <li><a href="/frontend/index.html" class="navbar-link">–ì–ª–∞–≤–Ω–∞—è</a></li>
        <li><a href="/frontend/pages/events.html" class="navbar-link">–°–æ–±—ã—Ç–∏—è</a></li>
        <li><a href="/frontend/pages/announcements.html" class="navbar-link">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a></li>
      </ul>
    </div>
  </nav>

  <!-- –î–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è -->
  <section class="section">
    <div class="container-sm">
      <div id="eventDetail">
        <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-brand">üé≠ PepeShnele</div>
      <div class="footer-links">
        <a href="/frontend/index.html" class="footer-link">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/frontend/pages/events.html" class="footer-link">–°–æ–±—ã—Ç–∏—è</a>
        <a href="/frontend/pages/announcements.html" class="footer-link">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a>
      </div>
      <div class="footer-bottom">¬© 2026 PepeShnele. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</div>
    </div>
  </footer>

  <script src="../js/utils.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    const eventId = getUrlParameter('id');
    let currentEvent = null;

    async function loadEventDetail() {
      const container = document.getElementById('eventDetail');
      
      if (!eventId) {
        showError(container, 'ID —Å–æ–±—ã—Ç–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω');
        return;
      }

      showLoading(container);

      try {
        const response = await eventsAPI.getById(eventId);
        currentEvent = response.data;
        renderEvent(currentEvent);
      } catch (error) {
        showError(container, '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏—è: ' + error.message);
      }
    }

    function renderEvent(event) {
      const container = document.getElementById('eventDetail');
      const isAuth = isAuthenticated();
      const currentUser = getCurrentUser();
      const isOwner = currentUser && event.createdBy._id === currentUser.id;
      const isPast = new Date(event.eventDate) < new Date();
      const userLiked = isAuth && event.likes.some(like => like.user === currentUser.id);
      
      container.innerHTML = `
        <div class="mb-3">
          <a href="/frontend/pages/events.html" class="text-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–æ–±—ã—Ç–∏—è–º</a>
        </div>

        <div class="card">
          <div class="event-card-image" style="height: 300px;"></div>
          
          <div class="card-body">
            <div class="flex justify-between items-center mb-3">
              <span class="badge badge-primary">${getCategoryEmoji(event.category)} ${getCategoryName(event.category)}</span>
              ${isOwner && isAdmin() ? `
                <div class="flex gap-2">
                  <button onclick="editEvent()" class="btn btn-sm btn-secondary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                  <button onclick="deleteEvent()" class="btn btn-sm btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </div>
              ` : ''}
            </div>

            <h1>${event.title}</h1>
            
            <div class="flex gap-3 mb-3 text-secondary">
              <span>üìÖ ${formatDate(event.eventDate)}</span>
              <span>üìç ${event.location}</span>
              <span>üë§ ${event.createdBy.username}</span>
            </div>

            <p style="white-space: pre-wrap; color: var(--text-secondary);">${event.description}</p>

            <div class="flex gap-3 mt-4">
              <button 
                onclick="toggleLike()" 
                class="btn ${userLiked ? 'btn-danger' : 'btn-outline'}"
                ${!isAuth ? 'disabled' : ''}
              >
                ${userLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${event.likes.length}
              </button>
              <span class="btn btn-secondary">üí¨ ${event.comments.length}</span>
              ${event.averageRating > 0 ? `<span class="btn btn-secondary">‚≠ê ${event.averageRating}</span>` : ''}
            </div>

            ${isPast && isAuth ? `
              <div class="mt-4">
                <h3>–û—Ü–µ–Ω–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ</h3>
                <div id="ratingContainer"></div>
              </div>
            ` : ''}
          </div>
        </div>

        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
        <div class="comments mt-4">
          <h3 class="mb-3">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (${event.comments.length})</h3>
          
          ${isAuth ? `
            <div class="card mb-4">
              <div class="card-body">
                <textarea 
                  id="commentInput" 
                  class="form-textarea" 
                  placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
                  rows="3"
                ></textarea>
                <button onclick="addComment()" class="btn btn-primary mt-2">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
              </div>
            </div>
          ` : `
            <div class="alert alert-info mb-4">
              <a href="/frontend/pages/login.html">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            </div>
          `}

          <div id="commentsContainer">
            ${event.comments.length === 0 ? '<p class="text-secondary">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>' : ''}
            ${event.comments.map(comment => renderComment(comment)).join('')}
          </div>
        </div>
      `;

      // –†–µ–π—Ç–∏–Ω–≥ –¥–ª—è –ø—Ä–æ—à–µ–¥—à–∏—Ö —Å–æ–±—ã—Ç–∏–π
      if (isPast && isAuth) {
        const userRating = event.ratings.find(r => r.user._id === currentUser.id);
        const ratingContainer = document.getElementById('ratingContainer');
        const interactiveStars = createInteractiveStars(userRating ? userRating.rating : 0, rateEvent);
        ratingContainer.appendChild(interactiveStars);
      }
    }

    function renderComment(comment) {
      const currentUser = getCurrentUser();
      const isOwner = currentUser && comment.user._id === currentUser.id;
      const userLiked = currentUser && comment.likes.includes(currentUser.id);

      return `
        <div class="comment">
          <div class="comment-header">
            <span class="comment-author">${comment.user.username}</span>
            <span class="comment-date">${timeAgo(comment.createdAt)}</span>
          </div>
          <div class="comment-body">${comment.content}</div>
          <div class="comment-actions">
            <button 
              onclick="toggleCommentLike('${comment._id}')" 
              class="comment-action"
              ${!isAuthenticated() ? 'disabled' : ''}
            >
              ${userLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${comment.likes.length}
            </button>
            ${ isOwner || isAdmin() ? `
              <button onclick="deleteComment('${comment._id}')" class="comment-action">
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
              </button>
            ` : ''}
          </div>
        </div>
      `;
    }

    // –õ–∞–π–∫ —Å–æ–±—ã—Ç–∏—è
    async function toggleLike() {
      if (!isAuthenticated()) return;
      
      try {
        await eventsAPI.toggleLike(eventId);
        loadEventDetail();
        showAlert('–õ–∞–π–∫ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
      } catch (error) {
        showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    // –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    async function addComment() {
      const input = document.getElementById('commentInput');
      const content = input.value.trim();
      
      if (!content) {
        showAlert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', 'warning');
        return;
      }

      try {
        await eventsAPI.addComment(eventId, content);
        input.value = '';
        loadEventDetail();
        showAlert('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
      } catch (error) {
        showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    // –£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    async function deleteComment(commentId) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')) return;

      try {
        await eventsAPI.deleteComment(eventId, commentId);
        loadEventDetail();
        showAlert('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–¥–∞–ª–µ–Ω', 'success');
      } catch (error) {
        showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    // –õ–∞–π–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    async function toggleCommentLike(commentId) {
      try {
        await eventsAPI.toggleCommentLike(eventId, commentId);
        loadEventDetail();
      } catch (error) {
        showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    // –û—Ü–µ–Ω–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ
    async function rateEvent(rating) {
      try {
        await eventsAPI.rate(eventId, rating);
        loadEventDetail();
        showAlert('–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É –æ—Ü–µ–Ω–∫—É!', 'success');
      } catch (error) {
        showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ
    function editEvent() {
      window.location.href = `/frontend/pages/admin/create-event.html?id=${eventId}`;
    }

    // –£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ
    async function deleteEvent() {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ?')) return;

      try {
        await eventsAPI.delete(eventId);
        showAlert('–°–æ–±—ã—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
        setTimeout(() => {
          window.location.href = '/frontend/pages/events.html';
        }, 1500);
      } catch (error) {
        showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    document.addEventListener('DOMContentLoaded', loadEventDetail);
  </script>
</body>
</html>
