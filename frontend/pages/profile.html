<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ—Ñ–∏–ª—å - PepeShnele</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <nav class="navbar">
    <div class="navbar-container">
      <a href="/frontend/index.html" class="navbar-brand">üé≠ PepeShnele</a>
      <button class="navbar-toggle">‚ò∞</button>
      <ul class="navbar-menu">
        <li><a href="/frontend/index.html" class="navbar-link">–ì–ª–∞–≤–Ω–∞—è</a></li>
        <li><a href="/frontend/pages/events.html" class="navbar-link">–°–æ–±—ã—Ç–∏—è</a></li>
        <li><a href="/frontend/pages/announcements.html" class="navbar-link">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a></li>
      </ul>
    </div>
  </nav>

  <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
  <section class="section">
    <div class="container-sm">
      <div id="profileContainer">
        <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-brand">üé≠ PepeShnele</div>
      <div class="footer-links">
        <a href="/frontend/index.html" class="footer-link">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/frontend/pages/events.html" class="footer-link">–°–æ–±—ã—Ç–∏—è</a>
        <a href="/frontend/pages/announcements.html" class="footer-link">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a>
      </div>
      <div class="footer-bottom">¬© 2026 PepeShnele. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</div>
    </div>
  </footer>

  <script src="../js/utils.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    if (!requireAuth()) {
      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç –Ω–∞ –ª–æ–≥–∏–Ω
    }

    let userProfile = null;

    async function loadProfile() {
      const container = document.getElementById('profileContainer');
      showLoading(container);

      try {
        const response = await userAPI.getProfile();
        userProfile = response.data;
        renderProfile();
      } catch (error) {
        showError(container, '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message);
      }
    }

    function renderProfile() {
      const container = document.getElementById('profileContainer');
      const user = userProfile;
      const initials = user.username.substring(0, 2).toUpperCase();

      container.innerHTML = `
        <div class="profile-header">
          <div class="profile-avatar">${initials}</div>
          <h1 class="profile-name">${user.username}</h1>
          <p class="profile-email">${user.email}</p>
          <span class="badge badge-${user.role === 'admin' ? 'warning' : 'primary'}" style="margin-top: 1rem;">
            ${user.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}
          </span>
        </div>

        <!-- –¢–∞–±—ã -->
        <div class="tabs">
          <button class="tab active" data-tab="favorites">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ (${user.favoriteEvents.length})</button>
          <button class="tab" data-tab="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
        </div>

        <!-- –ò–∑–±—Ä–∞–Ω–Ω–æ–µ -->
        <div id="tab-favorites" class="tab-content active">
          <div id="favoritesContainer" class="grid grid-2">
            <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
          </div>
        </div>

        <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è -->
        <div id="tab-edit" class="tab-content">
          <div class="card">
            <div class="card-body">
              <form id="editProfileForm">
                <div class="form-group">
                  <label for="username" class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                  <input 
                    type="text" 
                    id="username" 
                    class="form-input" 
                    value="${user.username}"
                    required
                    minlength="3"
                    maxlength="30"
                  >
                </div>

                <div class="form-group">
                  <label for="email" class="form-label">Email</label>
                  <input 
                    type="email" 
                    id="email" 
                    class="form-input" 
                    value="${user.email}"
                    required
                  >
                </div>

                <div id="editError"></div>

                <div class="flex gap-2">
                  <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                  <button type="button" onclick="logout()" class="btn btn-danger">–í—ã–π—Ç–∏</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–±–æ–≤
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          document.getElementById(`tab-${tabName}`).classList.add('active');
        });
      });

      // –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      document.getElementById('editProfileForm').addEventListener('submit', handleEditProfile);

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
      loadFavorites();
    }

    async function loadFavorites() {
      const container = document.getElementById('favoritesContainer');
      
      if (userProfile.favoriteEvents.length === 0) {
        showEmptyState(
          container,
          '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π',
          '–î–æ–±–∞–≤—å—Ç–µ —Å–æ–±—ã—Ç–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∏—Ö –∑–¥–µ—Å—å',
          '<a href="/frontend/pages/events.html" class="btn btn-primary">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–±—ã—Ç–∏—è</a>'
        );
        return;
      }

      container.innerHTML = userProfile.favoriteEvents.map(event => `
        <div class="card">
          <div class="card-body">
            <span class="badge badge-primary">${getCategoryEmoji(event.category)} ${getCategoryName(event.category)}</span>
            <h4 class="card-title">${event.title}</h4>
            <div class="event-meta">
              <span class="event-meta-item">üìÖ ${formatDateShort(event.eventDate)}</span>
              <span class="event-meta-item">üìç ${event.location}</span>
            </div>
            <div class="flex gap-2 mt-3">
              <a href="/frontend/pages/event-detail.html?id=${event._id}" class="btn btn-sm btn-primary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
              <button onclick="removeFavorite('${event._id}')" class="btn btn-sm btn-outline">üíî –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function handleEditProfile(e) {
      e.preventDefault();
      const errorDiv = document.getElementById('editError');
      errorDiv.innerHTML = '';

      const username = document.getElementById('username').value.trim();
      const email = document.getElementById('email').value.trim();

      if (!validateEmail(email)) {
        errorDiv.innerHTML = '<div class="alert alert-error">–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email</div>';
        return;
      }

      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

      try {
        await userAPI.updateProfile(username, email);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage
        const user = getCurrentUser();
        user.username = username;
        user.email = email;
        localStorage.setItem('user', JSON.stringify(user));
        
        showAlert('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
        loadProfile();
      } catch (error) {
        errorDiv.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      }
    }

    async function removeFavorite(eventId) {
      try {
        await userAPI.toggleFavorite(eventId);
        showAlert('–°–æ–±—ã—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'success');
        loadProfile();
      } catch (error) {
        showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }

    document.addEventListener('DOMContentLoaded', loadProfile);
  </script>
</body>
</html>
