<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ - PepeShnele Admin</title>
  <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <nav class="navbar">
    <div class="navbar-container">
      <a href="/frontend/index.html" class="navbar-brand">üé≠ PepeShnele</a>
      <button class="navbar-toggle">‚ò∞</button>
      <ul class="navbar-menu">
        <li><a href="/frontend/index.html" class="navbar-link">–ì–ª–∞–≤–Ω–∞—è</a></li>
        <li><a href="/frontend/pages/events.html" class="navbar-link">–°–æ–±—ã—Ç–∏—è</a></li>
        <li><a href="/frontend/pages/announcements.html" class="navbar-link">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a></li>
      </ul>
    </div>
  </nav>

  <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è -->
  <section class="section">
    <div class="container-sm">
      <h1 id="pageTitle">–°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</h1>
      
      <div class="card mt-4">
        <div class="card-body">
          <form id="eventForm">
            <div class="form-group">
              <label for="title" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è *</label>
              <input 
                type="text" 
                id="title" 
                class="form-input" 
                placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ..."
                required
                minlength="5"
                maxlength="200"
              >
            </div>

            <div class="form-group">
              <label for="description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
              <textarea 
                id="description" 
                class="form-textarea" 
                placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è..."
                required
                minlength="20"
                maxlength="5000"
                rows="6"
              ></textarea>
            </div>

            <div class="grid grid-2">
              <div class="form-group">
                <label for="category" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                <select id="category" class="form-select" required>
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                  <option value="education">üìö –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                  <option value="entertainment">üé≠ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
                  <option value="sports">‚öΩ –°–ø–æ—Ä—Ç</option>
                  <option value="technology">üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</option>
                  <option value="business">üíº –ë–∏–∑–Ω–µ—Å</option>
                  <option value="arts">üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ</option>
                  <option value="social">ü§ù –°–æ—Ü–∏–∞–ª—å–Ω–æ–µ</option>
                  <option value="other">üìå –î—Ä—É–≥–æ–µ</option>
                </select>
              </div>

              <div class="form-group">
                <label for="eventDate" class="form-label">–î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è *</label>
                <input 
                  type="datetime-local" 
                  id="eventDate" 
                  class="form-input" 
                  required
                >
              </div>
            </div>

            <div class="form-group">
              <label for="location" class="form-label">–ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è *</label>
              <input 
                type="text" 
                id="location" 
                class="form-input" 
                placeholder="–ê–¥—Ä–µ—Å –∏–ª–∏ –º–µ—Å—Ç–æ..."
                required
              >
            </div>

            <div id="errorMsg"></div>

            <div class="flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary">
                <span id="submitBtnText">–°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</span>
              </button>
              <a href="/frontend/pages/events.html" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-brand">üé≠ PepeShnele</div>
      <div class="footer-links">
        <a href="/frontend/index.html" class="footer-link">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/frontend/pages/events.html" class="footer-link">–°–æ–±—ã—Ç–∏—è</a>
        <a href="/frontend/pages/announcements.html" class="footer-link">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a>
      </div>
      <div class="footer-bottom">¬© 2026 PepeShnele. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</div>
    </div>
  </footer>

  <script src="../../js/utils.js"></script>
  <script src="../../js/api.js"></script>
  <script src="../../js/auth.js"></script>
  <script>
    // –ó–∞—â–∏—Ç–∞: —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
    if (!requireAdmin()) {
      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç
    }

    const eventId = getUrlParameter('id');
    const isEditMode = !!eventId;

    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É (—Å–µ–≥–æ–¥–Ω—è)
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('eventDate').min = now.toISOString().slice(0, 16);

    // –ï—Å–ª–∏ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if (isEditMode) {
      document.getElementById('pageTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ';
      document.getElementById('submitBtnText').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
      loadEventForEdit();
    }

    async function loadEventForEdit() {
      try {
        const response = await eventsAPI.getById(eventId);
        const event = response.data;

        document.getElementById('title').value = event.title;
        document.getElementById('description').value = event.description;
        document.getElementById('category').value = event.category;
        document.getElementById('location').value = event.location;
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è input
        const eventDate = new Date(event.eventDate);
        eventDate.setMinutes(eventDate.getMinutes() - eventDate.getTimezoneOffset());
        document.getElementById('eventDate').value = eventDate.toISOString().slice(0, 16);
      } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏—è: ' + error.message, 'error');
        setTimeout(() => window.location.href = '/frontend/pages/events.html', 2000);
      }
    }

    document.getElementById('eventForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.innerHTML = '';

      const eventData = {
        title: document.getElementById('title').value.trim(),
        description: document.getElementById('description').value.trim(),
        category: document.getElementById('category').value,
        eventDate: document.getElementById('eventDate').value,
        location: document.getElementById('location').value.trim(),
      };

      // –í–∞–ª–∏–¥–∞—Ü–∏—è
      if (!eventData.title || !eventData.description || !eventData.category || !eventData.eventDate || !eventData.location) {
        errorMsg.innerHTML = '<div class="alert alert-error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è</div>';
        return;
      }

      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.querySelector('span').textContent;
      submitBtn.disabled = true;
      submitBtn.querySelector('span').textContent = isEditMode ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ–∑–¥–∞–Ω–∏–µ...';

      try {
        if (isEditMode) {
          await eventsAPI.update(eventId, eventData);
          showAlert('–°–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
        } else {
          await eventsAPI.create(eventData);
          showAlert('–°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ!', 'success');
        }
        
        setTimeout(() => {
          window.location.href = '/frontend/pages/events.html';
        }, 1500);
      } catch (error) {
        errorMsg.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
        submitBtn.disabled = false;
        submitBtn.querySelector('span').textContent = originalText;
      }
    });
  </script>
</body>
</html>
