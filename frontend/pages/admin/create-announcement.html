<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ - PepeShnele Admin</title>
  <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <nav class="navbar">
    <div class="navbar-container">
      <a href="/frontend/index.html" class="navbar-brand">üé≠ PepeShnele</a>
      <button class="navbar-toggle">‚ò∞</button>
      <ul class="navbar-menu">
        <li><a href="/frontend/index.html" class="navbar-link">–ì–ª–∞–≤–Ω–∞—è</a></li>
        <li><a href="/frontend/pages/events.html" class="navbar-link">–°–æ–±—ã—Ç–∏—è</a></li>
        <li><a href="/frontend/pages/announcements.html" class="navbar-link">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a></li>
      </ul>
    </div>
  </nav>

  <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è -->
  <section class="section">
    <div class="container-sm">
      <h1>–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h1>
      
      <div class="card mt-4">
        <div class="card-body">
          <form id="announcementForm">
            <div class="form-group">
              <label for="title" class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
              <input 
                type="text" 
                id="title" 
                class="form-input" 
                placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫..."
                required
                minlength="5"
                maxlength="200"
              >
            </div>

            <div class="form-group">
              <label for="content" class="form-label">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ *</label>
              <textarea 
                id="content" 
                class="form-textarea" 
                placeholder="–¢–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è..."
                required
                minlength="20"
                maxlength="5000"
                rows="8"
              ></textarea>
            </div>

            <div class="form-group">
              <label for="event" class="form-label">–°–≤—è–∑–∞—Ç—å —Å —Å–æ–±—ã—Ç–∏–µ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <select id="event" class="form-select">
                <option value="">–ù–µ —Å–≤—è–∑–∞–Ω–æ —Å —Å–æ–±—ã—Ç–∏–µ–º</option>
              </select>
              <span class="form-hint">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</span>
            </div>

            <div id="errorMsg"></div>

            <div class="flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</button>
              <a href="/frontend/pages/announcements.html" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-brand">üé≠ PepeShnele</div>
      <div class="footer-links">
        <a href="/frontend/index.html" class="footer-link">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/frontend/pages/events.html" class="footer-link">–°–æ–±—ã—Ç–∏—è</a>
        <a href="/frontend/pages/announcements.html" class="footer-link">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a>
      </div>
      <div class="footer-bottom">¬© 2026 PepeShnele. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</div>
    </div>
  </footer>

  <script src="../../js/utils.js"></script>
  <script src="../../js/api.js"></script>
  <script src="../../js/auth.js"></script>
  <script>
    // –ó–∞—â–∏—Ç–∞: —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
    if (!requireAdmin()) {
      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π
    async function loadEvents() {
      try {
        const response = await eventsAPI.getAll();
        const events = response.data;
        
        const select = document.getElementById('event');
        events.forEach(event => {
          const option = document.createElement('option');
          option.value = event._id;
          option.textContent = `${event.title} (${formatDateShort(event.eventDate)})`;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π:', error);
      }
    }

    document.getElementById('announcementForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.innerHTML = '';

      const announcementData = {
        title: document.getElementById('title').value.trim(),
        content: document.getElementById('content').value.trim(),
      };

      const eventId = document.getElementById('event').value;
      if (eventId) {
        announcementData.event = eventId;
      }

      // –í–∞–ª–∏–¥–∞—Ü–∏—è
      if (!announcementData.title || !announcementData.content) {
        errorMsg.innerHTML = '<div class="alert alert-error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è</div>';
        return;
      }

      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';

      try {
        await announcementsAPI.create(announcementData);
        showAlert('–û–±—ä—è–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!', 'success');
        
        setTimeout(() => {
          window.location.href = '/frontend/pages/announcements.html';
        }, 1500);
      } catch (error) {
        errorMsg.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
        submitBtn.disabled = false;
        submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ';
      }
    });

    document.addEventListener('DOMContentLoaded', loadEvents);
  </script>
</body>
</html>
